name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a new release'
        required: true
        default: 'false'

env:
  PROJECT_PATH: Mifare Classic Tool

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        working-directory: ${{ env.PROJECT_PATH }}
        run: chmod +x gradlew
      
      - name: Build Debug APK
        working-directory: ${{ env.PROJECT_PATH }}
        run: ./gradlew assembleDebug
      
      - name: Build Release APK
        working-directory: ${{ env.PROJECT_PATH }}
        run: ./gradlew assembleRelease
      
      - name: Get version name
        id: version
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          VERSION=$(grep "versionName" app/build.gradle | awk '{print $2}' | tr -d "'")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Rename APKs
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mv app/build/outputs/apk/debug/app-debug.apk \
             app/build/outputs/apk/debug/Monti_Mifare_NFCCFN-${{ steps.version.outputs.version }}-debug.apk
          mv app/build/outputs/apk/release/app-release-unsigned.apk \
             app/build/outputs/apk/release/Monti_Mifare_NFCCFN-${{ steps.version.outputs.version }}-release.apk
      
      - name: Generate checksums
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          cd app/build/outputs/apk/debug
          sha256sum *.apk > checksums-debug.txt
          cd ../release
          sha256sum *.apk > checksums-release.txt
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: |
            ${{ env.PROJECT_PATH }}/app/build/outputs/apk/debug/*.apk
            ${{ env.PROJECT_PATH }}/app/build/outputs/apk/debug/checksums-debug.txt
          retention-days: 30
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: |
            ${{ env.PROJECT_PATH }}/app/build/outputs/apk/release/*.apk
            ${{ env.PROJECT_PATH }}/app/build/outputs/apk/release/checksums-release.txt
          retention-days: 90

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: debug-apk
          path: ./artifacts/debug
      
      - name: Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: ./artifacts/release
      
      - name: Get version info
        id: version_info
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep "versionName" "$PROJECT_PATH/app/build.gradle" | awk '{print $2}' | tr -d "'")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
      
      - name: Extract changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.txt ]; then
            # Extract the latest version changes from CHANGELOG.txt
            awk '/^Version [0-9]/{if(++count==1){flag=1; next} else {flag=0}} flag' CHANGELOG.txt > release_notes.txt
            if [ ! -s release_notes.txt ]; then
              echo "Bug fixes and improvements" > release_notes.txt
            fi
          else
            echo "Bug fixes and improvements" > release_notes.txt
          fi
          echo "Release notes generated"
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > full_release_notes.md << 'EOF'
          ## Monti_Mifare_NFCCFN ${{ steps.version_info.outputs.version }}
          
          ### What's New
          
          EOF
          cat release_notes.txt >> full_release_notes.md
          cat >> full_release_notes.md << 'EOF'
          
          ### MontiNode Network Integration
          
          This release includes enhanced integration with the MontiNode network:
          
          - **GATT Key Derivation**: Bluetooth-based secure key exchange
          - **Telephony Integration**: SIM card-based key derivation
          - **MontiTransmuter Encoding**: Advanced key transformation algorithm
          - **Wireless Security Module**: Enhanced security features
          - **Network State Management**: Synchronized asset management
          
          ### Download Options
          
          - **Release APK** (Recommended): Optimized for production use
          - **Debug APK**: For development and testing
          
          See [DOWNLOADS.md](https://github.com/montinode/Monti_Mifare_NFCCFN/blob/main/DOWNLOADS.md) for detailed installation instructions.
          
          ### Documentation
          
          - [MontiNode Integration Guide](https://github.com/montinode/Monti_Mifare_NFCCFN/blob/main/MONTINODE_INTEGRATION.md)
          - [Download & Installation Guide](https://github.com/montinode/Monti_Mifare_NFCCFN/blob/main/DOWNLOADS.md)
          - [Configuration Reference](https://github.com/montinode/Monti_Mifare_NFCCFN/blob/main/montinode.json)
          
          ### Checksums
          
          Verify your download using the checksums files included in this release.
          
          ### Requirements
          
          - Android 4.4 (API 19) or higher
          - NFC hardware with MIFARE Classic support
          - For MontiNode features: Internet connectivity and network credentials
          
          ### Support
          
          - Report issues: https://github.com/montinode/Monti_Mifare_NFCCFN/issues
          - Community forum: https://forum.montiai.com
          - Documentation: https://docs.johncharlesmonti.com/mct
          EOF
          echo "Release notes prepared"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_info.outputs.tag }}
          name: Release ${{ steps.version_info.outputs.version }}
          body_path: full_release_notes.md
          draft: false
          prerelease: false
          files: |
            ./artifacts/release/*.apk
            ./artifacts/release/checksums-release.txt
            ./artifacts/debug/*.apk
            ./artifacts/debug/checksums-debug.txt
            MONTINODE_INTEGRATION.md
            DOWNLOADS.md
            montinode.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to MontiNode Network
        if: success()
        run: |
          echo "Note: Uploading to MontiNode network requires authentication"
          echo "This would normally sync the release to MontiNode CDN"
          echo "Skipping in automated build - manual upload required"
          # In a production setup, this would authenticate and upload:
          # curl -X POST https://api.johncharlesmonti.com/v1/releases \
          #   -H "Authorization: Bearer ${{ secrets.MONTINODE_API_KEY }}" \
          #   -F "file=@./artifacts/release/*.apk" \
          #   -F "version=${{ steps.version_info.outputs.version }}"

  notify:
    name: Notify Release
    needs: release
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Notify success
        run: |
          echo "Release created successfully!"
          echo "Users can now download from:"
          echo "- GitHub Releases"
          echo "- MontiNode Network (after sync)"
          echo "- F-Droid (after upstream sync)"
